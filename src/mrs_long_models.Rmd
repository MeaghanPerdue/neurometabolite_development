---
title: "MRS Longitudinal Modelling"
author: "Meaghan Perdue"
date: "2022/01/19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = '/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/')
library(tidyverse)
library(lme4)
library(lmerTest)
library(ggplot2)
library(ggpubr)
library(EnvStats)
library(psych)
library(viridis)
library(remef)
# Turn off scientific notation
options(scipen=999)
```

## Organize data

Merge output data from multiple batches, select metabolite columns, add participant info and other data

```{r}
acg_batch1 <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/ACG_LCM_CorrectedTable_12-14-2021-16-15.csv")

acg_batch2 <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/ACG_LCM_CorrectedTable_12-14-2021-16-21.csv")

acg_LCM_corr <- bind_rows(acg_batch1, acg_batch2)
anyDuplicated(acg_LCM_corr$File_ID) #check for duplicated values
acg_LCM_corr<-unique(acg_LCM_corr) #remove duplicate rows
acg_LCM_corr["4", "Cho_GPC_PCh_conc_molar"]<-NA #Cho conc invalid for PS10008_PS14_046_2386 due to spike in spectrum
acg_LCM_corr["4", "Ins_conc_molal"]<-NA #Cho conc invalid for PS10008_PS14_046_2386 due to spike in spectrum

write.csv(acg_LCM_corr, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/ACG_LCM_CorrectedTable_19-01-2021_all.csv", row.names = FALSE)

acg_molal <- acg_LCM_corr %>%
  dplyr::select(File_ID, fGM, fWM, fCSF, NAA_conc_molal, Cre_PCr_conc_molal, Ins_conc_molal, Ins_conc_molal, Glu_conc_molal, Glu_Gln_conc_molal)

acg_demo <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_analysis_subs.csv")

acg_dat <- left_join(acg_demo, acg_molal, by = "File_ID")

#convert subj_id variable to "character" type for later merging
acg_dat$subj_id <- as.character(acg_dat$subj_id)

write.csv(acg_dat, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_n114_usethisone.csv", row.names = FALSE)

lag_batch1 <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/LAG_LCM_CorrectedTable_12-13-2021-15-18.csv")

lag_batch2 <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/LAG_LCM_CorrectedTable_12-14-2021-11-41.csv")

lag_batch3 <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/LAG_LCM_CorrectedTable_12-14-2021-12-18.csv")

lag_LCM_corr <- bind_rows(lag_batch1, lag_batch2, lag_batch3)
write.csv(lag_LCM_corr, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/LAG_LCM_CorrectedTable_19-01-2022_all.csv", row.names = FALSE)

lag_molal <- lag_LCM_corr %>%
  dplyr::select(File_ID, fGM, fWM, fCSF, NAA_conc_molal, Cre_PCr_conc_molal, Cho_GPC_PCh_conc_molal, Ins_conc_molal, Glu_conc_molal, Glu_Gln_conc_molal)

lag_demo <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_analysis_subs.csv")

lag_dat <- left_join(lag_demo, lag_molal, by = "File_ID")
lag_dat$subj_id<-as.character(lag_dat$subj_id) #make subj_id character type

write.csv(lag_dat, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_n320_usethisone.csv", row.names = FALSE)

```
##Check data distribution & outliers
Create plots to check data distribution and identify outliers

ACG
```{r}
plot_age <- ggplot(acg_dat, aes(mri_age_y))
plot_age + geom_density()
#age skewed (expected given study design, accounting for repeated measures in lmer)

plot_naa <- ggplot(acg_dat, aes(NAA_conc_molal))
plot_naa + geom_density()
plot_naa + geom_boxplot()
rosnerTest(acg_dat$NAA_conc_molal, k = 4)

plot_cre <- ggplot(acg_dat, aes(Cre_PCr_conc_molal))
plot_cre + geom_density()
plot_cre + geom_boxplot()
rosnerTest(acg_dat$Cre_PCr_conc_molal, k = 5)

plot_cho <- ggplot(acg_dat, aes(Cho_GPC_PCh_conc_molal))
plot_cho + geom_density()
plot_cho + geom_boxplot()
rosnerTest(acg_dat$Cho_GPC_PCh_conc_molal, k = 4)

plot_ins <- ggplot(acg_dat, aes(Ins_conc_molal))
plot_ins + geom_density()
shapiro.test(acg_dat$Ins_conc_molal) #not normal
plot_ins + geom_boxplot()
rosnerTest(acg_dat$Ins_conc_molal, k = 3) #outlier value 1.471244, observation 84 (PS18_013) - spectrum showed issue, exclude from analysis 
acg_dat["84", "Ins_conc_molal"] <- NA #replace outlier value with NA to exclude from analysis

plot_glx <- ggplot(acg_dat, aes(Glu_Gln_conc_molal))
plot_glx + geom_density()
plot_glx + geom_boxplot()
rosnerTest(acg_dat$Glu_Gln_conc_molal, k = 1)

write.csv(acg_dat, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_outliers_removed_n114.csv", row.names = FALSE)
```
LAG
```{r}
plot_age <- ggplot(lag_dat, aes(mri_age_y))
plot_age + geom_density()
#age skewed, we're accounting for repeated measures with lmer

plot_naa <- ggplot(lag_dat, aes(NAA_conc_molal))
plot_naa + geom_density()
plot_naa + geom_boxplot()
rosnerTest(lag_dat$NAA_conc_molal, k = 10) #outliers val. 19.207, obs. 296 & Val. 10.148, obs. 306 - some issues in spectra, exclude from analysis for NAA
lag_dat["296", "NAA_conc_molal"]<- NA
lag_dat["306", "NAA_conc_molal"]<- NA

plot_cre <- ggplot(lag_dat, aes(Cre_PCr_conc_molal))
plot_cre + geom_density()
plot_cre + geom_boxplot()
rosnerTest(lag_dat$Cre_PCr_conc_molal, k = 10) #outliers val. 14.829, obs. 241 (PS17_047) - structure in resid. & val. 14.09, obs. 178 (PS17_045, spectrum looked fine), excluding only PS17_047 for now
lag_dat["241", "Cre_PCr_conc_molal"]<-NA  #replace outlier value with NA to exclude from analysis

plot_cho <- ggplot(lag_dat, aes(Cho_GPC_PCh_conc_molal))
plot_cho + geom_density()
plot_cho + geom_boxplot()
rosnerTest(lag_dat$Cho_GPC_PCh_conc_molal, k = 8)

plot_ins <- ggplot(lag_dat, aes(Ins_conc_molal))
plot_ins + geom_density()
plot_ins + geom_boxplot()
rosnerTest(lag_dat$Ins_conc_molal, k = 8) #outliers: val. 14.077, obs. 241 (PS17_047) - structure in resid; val. 11.777, obs. 221 (PS16_014) - spectrum fine, keep for now; val. 1.542, obs. 197 (PS18_028) - noisy spectrum, spiky residuals, exclude; val. 2.04, obs. 62 (PS14_111) - spectrum fine, keep for now
lag_dat["241", "Ins_conc_molal"] <- NA #replace outlier value with NA to exclude from analysis
lag_dat["197", "Ins_conc_molal"] <- NA

plot_glx <- ggplot(lag_dat, aes(Glu_Gln_conc_molal))
plot_glx + geom_density()
plot_glx + geom_boxplot()
rosnerTest(lag_dat$Glu_Gln_conc_molal, k = 7)#outliers: val. 10.09, obs. 241 (PS17_047) - structure in resid; val. 31.2899, obs. 296 (PS21_030) - big spike in resid. around 2.1, exclude.
lag_dat["241", "Glu_Gln_conc_molal"] <- NA
lag_dat["296", "Glu_Gln_conc_molal"] <- NA

#exclude PS17_047 from all analyses due to outlier status on multiple metabolites and issues in spectrum (noisy, structure in resid)
lag_dat <- lag_dat[ !(lag_dat$study_code %in% "PS17_047"), ]

write.csv(lag_dat, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319.csv", row.names = FALSE)
```

##Descriptive stats
```{r}
#ACG - count individual subject N and N of females
acg_sub_sex <- acg_dat %>%
  dplyr::select(subj_id, female)
acg_unique_subs<-unique(acg_sub_sex)
length(acg_unique_subs$subj_id)
sum(acg_unique_subs$female)

describe(acg_dat)

#re-run descriptives afer excluding 2 subjects for poor coregistration
acg_dat_tf<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_outliers_removed_n112_tissuefraction.csv")
#convert subj_id variable to "character" type for later merging
#acg_dat_tf$subj_id <- as.character(acg_dat_tf$subj_id)

acg_sub_sex <- acg_dat_tf %>%
  dplyr::select(subj_id, female)
acg_unique_subs<-unique(acg_sub_sex)
length(acg_unique_subs$subj_id)
sum(acg_unique_subs$female)

describe(acg_dat_tf)

#pull means and SDs of metabolites
acg_desc<-acg_dat_tf %>%
  describe() %>%
  select(c("n", "mean", "sd", "min", "max"))
acg_metab_desc<-filter(acg_desc, row.names(acg_desc) %in% c("NAA_conc_molal", "Cho_GPC_PCh_conc_molal", "Cre_PCr_conc_molal", "Glu_Gln_conc_molal", "Ins_conc_molal", "TissueFraction_GMWM"))

#write to csv
write.csv(acg_metab_desc, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_metab_descriptives.csv")



#LAG - count individual subject N and N of females
lag_dat_tf<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319_tissuefraction.csv")

lag_sub_sex <- lag_dat_tf %>%
  dplyr::select(subj_id, female)
lag_unique_subs<-unique(lag_sub_sex)
length(lag_unique_subs$subj_id)
sum(lag_unique_subs$female)

describe(lag_dat_tf)

#pull means and SDs of metabolites
lag_desc<-lag_dat_tf %>%
  describe() %>%
  select(c("n", "mean", "sd", "min", "max"))
lag_metab_desc<-filter(lag_desc, row.names(lag_desc) %in% c("NAA_conc_molal", "Cho_GPC_PCh_conc_molal", "Cre_PCr_conc_molal", "Glu_Gln_conc_molal", "Ins_conc_molal", "TissueFraction_GMWM"))

#write to csv
write.csv(lag_metab_desc, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_metab_descriptives.csv")

#merge ACG & LAG datasets
all_dat<-bind_rows(acg_dat_tf, lag_dat_tf)

#add SES data

#parent 1 data
ses_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/Preschool_demographics_Visit1_Feb2022.csv")
colnames(ses_dat)[1]<-"subj_id"

all_dat<-left_join(all_dat, ses_dat, by = "subj_id")

describe(all_dat)

#Calculate total Ns from both datasets combined
length(unique(all_dat$File_ID))
length(unique(all_dat$subj_id))
all_sub_sex <- all_dat %>%
  dplyr::select(subj_id, female)
all_unique_subs<-unique(all_sub_sex)
sum(all_unique_subs$female)

#reduce dataframe to single row per participant
dat<-all_dat %>% 
  select("subj_id", "female", "mom_highest_schooling", "dad_highest_schooling", "dm_income") %>%
  distinct()

describe(dat)
sum(dat$female)

```


## LME modelling ACG
run mixed-effects models for ACG with participant as random effect, age, sex and age x sex interaction as fixed effects
NAA
run on acg_data_molal_outliers_removed_n113.csv
```{r}
acg_naa_age<- lmer(NAA_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_naa_age)

acg_naa_age_sex<- lmer(NAA_conc_molal ~ mri_age_y + female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_naa_age_sex)

anova(acg_naa_age,acg_naa_age_sex)

acg_naa_ageXsex<- lmer(NAA_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_naa_ageXsex)

anova(acg_naa_age,acg_naa_ageXsex)

#including sex in model does not significantly improve fit 
```
Cre
```{r}
acg_cre_age<- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_cre_age)

acg_cre_age_sex<- lmer(Cre_PCr_conc_molal ~ mri_age_y + female + (1 | subj_id), data=acg_dat,  REML=FALSE)
summary(acg_cre_age_sex)

anova(acg_cre_age,acg_cre_age_sex)

acg_cre_ageXsex<- lmer(Cre_PCr_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_cre_ageXsex)

anova(acg_cre_age,acg_cre_ageXsex)
```
Cho
```{r}
acg_cho_age<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat,  REML=FALSE)
summary(acg_cho_age)

acg_cho_age_sex<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + female + (1 | subj_id), data=acg_dat,  REML=FALSE)
summary(acg_cho_age_sex)

anova(acg_cho_age,acg_cho_age_sex)

acg_cho_ageXsex<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=acg_dat,  REML=FALSE)
summary(acg_cho_ageXsex)

anova(acg_cho_age,acg_cho_ageXsex)

#including sex in model does not significantly improve fit 
```
Ins
```{r}
acg_ins_age<- lmer(Ins_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_ins_age)

acg_ins_age_sex<- lmer(Ins_conc_molal ~ mri_age_y + female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_ins_age_sex)

anova(acg_ins_age,acg_ins_age_sex)

acg_ins_ageXsex<- lmer(Ins_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_ins_ageXsex)

anova(acg_ins_age,acg_ins_ageXsex)
```

Glx
```{r}
acg_glx_age<- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_glx_age)

acg_glx_age_sex<- lmer(Glu_Gln_conc_molal ~ mri_age_y + female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_glx_age_sex)

anova(acg_glx_age,acg_glx_age_sex)

acg_glx_ageXsex<- lmer(Glu_Gln_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=acg_dat, REML=FALSE)
summary(acg_glx_ageXsex)

anova(acg_glx_age,acg_glx_ageXsex)
```

## Plot results ACG
Create scatter plot with regression line based on model predictions
NAA
```{r}
acg_dat <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_outliers_removed_n114.csv")

#pull intercept and slope from model for regression line
fixef.acg_naa<-fixef(acg_naa_age)

#plot
plot_acg_naa_age<-ggplot(acg_dat, aes(x=mri_age_y, y=NAA_conc_molal,color=as.factor(female))) +
  geom_point() +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "tNAA (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=NAA_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  geom_abline(aes(intercept = fixef.acg_naa[[1]], slope= fixef.acg_naa[[2]])) + 
  theme_classic()
plot_acg_naa_age
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_naa_age_viridis.png")


```
Cho
```{r}
#pull intercept and slope from model for regression line
fixef.acg_cho<-fixef(acg_cho_age)

#plot
plot_acg_cho_age<-ggplot(acg_dat, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal,color=as.factor(female))) + 
  geom_point() +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  geom_abline(aes(intercept = fixef.acg_cho[[1]], slope= fixef.acg_cho[[2]])) + 
  theme_classic()
plot_acg_cho_age
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_cho_age_viridis.png")
```
Ins
```{r}
#pull intercept and slope from model for regression line
fixef.acg_ins<-fixef(acg_ins_age)

#plot
plot_acg_ins_age<-ggplot(acg_dat, aes(x=mri_age_y, y=Ins_conc_molal,color=as.factor(female))) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Ins_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "Ins (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.acg_ins[[1]], slope= fixef.acg_ins[[2]])) + 
  theme_classic()
plot_acg_ins_age
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_ins_age_viridis.png")
```


## LME modelling LAG
run mixed-effects models for lag with participant as random effect, age, sex and age x sex interaction as fixed effects
NAA, substantial longitudinal data so we include random slope
run on lag_data_molal_outliers_removed_n320.csv
```{r}
#basic model effect of age on intercept
lag_naa_age<- lmer(NAA_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age)

lag_naa_age_sex<- lmer(NAA_conc_molal ~ mri_age_y + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_sex)

anova(lag_naa_age,lag_naa_age_sex)

lag_naa_ageXsex<- lmer(NAA_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_ageXsex)

anova(lag_naa_age,lag_naa_ageXsex)

#including sex in model does not significantly improve fit 
```
Cre
```{r}
lag_cre_age<- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age)

lag_cre_age_sex<- lmer(Cre_PCr_conc_molal ~ mri_age_y + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age_sex)

anova(lag_cre_age,lag_cre_age_sex)

lag_cre_ageXsex<- lmer(Cre_PCr_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_ageXsex)

anova(lag_cre_age,lag_cre_ageXsex)
```
Cho
```{r}
lag_cho_age<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age)

lag_cho_age_sex<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_sex)

anova(lag_cho_age,lag_cho_age_sex)

lag_cho_ageXsex<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_ageXsex)

anova(lag_cho_age,lag_cho_ageXsex)

#including sex in model does not significantly improve fit 
```
Ins
```{r}
lag_ins_age<- lmer(Ins_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age)

lag_ins_age_sex<- lmer(Ins_conc_molal ~ mri_age_y + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_sex)

anova(lag_ins_age,lag_ins_age_sex)

lag_ins_ageXsex<- lmer(Ins_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_ageXsex)

anova(lag_ins_age,lag_ins_ageXsex)
```

Glx
```{r}
lag_glx_age<- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
# boundary (singular) fit: model is almost/near singular (parameters are on the boundary of the feasible parameter space: random effects variance = 0)
summary(lag_glx_age)

lag_glx_age_sex<- lmer(Glu_Gln_conc_molal ~ mri_age_y + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_sex)

anova(lag_glx_age,lag_glx_age_sex)

lag_glx_ageXsex<- lmer(Glu_Gln_conc_molal ~ mri_age_y + female + mri_age_y:female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_ageXsex)

anova(lag_glx_age,lag_glx_ageXsex)
```

## Plot results LAG
Create scatter plot with regression line based on model predictions
NAA
```{r}
#pull intercept and slope from model for regression line
fixef.lag_naa<-fixef(lag_naa_age)

#plot
plot_lag_naa_age<-ggplot(lag_dat, aes(x=mri_age_y, y=NAA_conc_molal,color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=NAA_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tNAA (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_naa[[1]], slope= fixef.lag_naa[[2]])) + 
  theme_classic()
plot_lag_naa_age 
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_naa_age_viridis.png")
```

Cho
```{r}
#pull intercept and slope from model for regression line
fixef.lag_cho<-fixef(lag_cho_age)

#plot
plot_lag_cho_age<-ggplot(lag_dat, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal,color=as.factor(female))) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_cho[[1]], slope= fixef.lag_cho[[2]])) + 
  theme_classic()
plot_lag_cho_age 
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_viridis.png")

```

Glx
```{r}
#pull intercept and slope from model for regression line
fixef.lag_glx<-fixef(lag_glx_age)

#plot
plot_lag_glx_age<-ggplot(lag_dat, aes(x=mri_age_y, y=Glu_Gln_conc_molal,color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Glu_Gln_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "Glx (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_glx[[1]], slope= fixef.lag_glx[[2]])) + 
  theme_classic()
plot_lag_glx_age 
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_glx_age_viridis.png")

```

##Combine results plots into 1 figure
Simplify plots to legend & region don't repeat in each panel
```{r}
library(patchwork)
p1_acg_naa_age<-plot_acg_naa_age + 
  geom_point() +
  geom_line(aes(group = as.factor(subj_id))) +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "tNAA (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.acg_naa[[1]], slope= fixef.acg_naa[[2]])) + 
  theme_classic() +
  theme(plot.title= element_text(hjust = 0.5))

p4_lag_naa_age<-plot_lag_naa_age + 
  geom_point() +
  geom_line(aes(group = as.factor(subj_id))) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tNAA (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  theme_classic() +
  #theme(legend.position = c(0.7, 0.95), legend.background = element_rect(fill='transparent')) +
  geom_abline(aes(intercept = fixef.lag_naa[[1]], slope= fixef.lag_naa[[2]])) +
  theme(plot.title= element_text(hjust = 0.5))


p2_acg_cho_age<-plot_acg_cho_age + 
  geom_point() +
  geom_line(aes(group = as.factor(subj_id))) +
  labs(x = "Age (years)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.acg_cho[[1]], slope= fixef.acg_cho[[2]])) + 
  theme_classic() 
  

p5_lag_cho_age<-plot_lag_cho_age + 
  geom_point() +
  geom_line(aes(group = as.factor(subj_id))) +
  labs(x = "Age (years)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_cho[[1]], slope= fixef.lag_cho[[2]])) + 
  theme_classic()

p3_acg_ins_age<-plot_acg_ins_age + 
  geom_point() +
  geom_line(aes(group = as.factor(subj_id))) +
  labs(x = "Age (years)", y = "Ins (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.acg_ins[[1]], slope= fixef.acg_ins[[2]])) + 
  theme_classic()

p6_lag_glx_age<-plot_lag_glx_age + 
  geom_point() +
  geom_line(aes(group = as.factor(subj_id))) +
  labs(x = "Age (years)", y = "Glx (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_glx[[1]], slope= fixef.lag_glx[[2]])) + 
  theme_classic()

results_fig<-p1_acg_naa_age + p4_lag_naa_age + p2_acg_cho_age + p5_lag_cho_age + p3_acg_ins_age + p6_lag_glx_age + plot_layout(nrow=3, guides ='collect')

ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/results_fig_grid_viridis.png", results_fig, width = 2000, units = "px")

```

##Correct for multiple comparisons
Use FDR method (Benjamini & Hochberg) to correct for mutliple comparisons (5 metabolites x 2 voxels = 10 models)
```{r}
## 19-01-2022: need to re-run if using these models!
#list models (voxel/metabolite pair)
models<- c("acg_naa", "acg_cr", "acg_cho", "acg_ins", "acg_glx", "lag_naa", "lag_cr", "lag_cho", "lag_ins", "lag_glx")

#list p-values for each model, matching order of models
p<-c(.0217, .307, .0258, .0494, .23, .00093, .115, .00229, .636, 0)

fdr_table<-data.frame(models, p)

fdr_table$p_fdr<-p.adjust(p, method = "fdr", n= length(p))
fdr_table

#run FDR without LAG-Glx in case it's invalid:
p2<-c(.0217, .307, .0258, .0494, .23, .00093, .115, .00229, .636)
p.adjust(p2, method = "fdr", n= length(p2))

```


##Additional models
Next steps following OHBM abstract submission (Dec. 2021): test random slopes (LAG only) 

```{r}
#read in data
lag_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319.csv")

#basic age model NAA
lag_naa_age<- lmer(NAA_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age)

#test random slope NAA
lag_naa_age_randslope <- lmer(NAA_conc_molal ~ mri_age_y + (1 + mri_age_y | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_randslope)

anova(lag_naa_age, lag_naa_age_randslope) #not sig.

#basic age model Cre
lag_cre_age<- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age)

#test random slope Cre
lag_cre_age_randslope<- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 + mri_age_y | subj_id), data=lag_dat, REML=FALSE)
#model failed to converge

#basic age model Cho
lag_cho_age<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age)

#test random slope Cho
lag_cho_age_randslope<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 + mri_age_y | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_randslope)

#compare models
anova(lag_cho_age, lag_cho_age_randslope) #fit did not improve with inclusion of random slopes

#basic age model Ins
lag_ins_age<- lmer(Ins_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age)

#test random slope Ins
lag_ins_age_randslope<- lmer(Ins_conc_molal ~ mri_age_y + (1 + mri_age_y | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_randslope)
#boundary fit is singular

anova(lag_ins_age, lag_ins_age_randslope) #fit did not improve with inclusion of random slopes

lag_glx_age<- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age)
#boundary fit is singular

lag_glx_age_randslope<- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 + mri_age_y | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_randslope)
#boundary fit is singular
anova(lag_glx_age, lag_glx_age_randslope) #fit did not improve with inclusion of random slopes

```

##Tissue fraction analysis
Calculate tissue fraction GM/(GM+WM) for each subject/voxel
Add tissue fraction as fixed effect in lmer models
ACG
```{r}
library(ggplot2)
library(EnvStats)
library(lme4)
library(lmerTest)
#ACG - USE THESE MODELS!! (identified 2 subjects with poor coregistration & removed them)
#read in data
acg_dat <- read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_outliers_removed_n114.csv")

#create tissue fraction variable
acg_dat$TissueFraction_GMWM <- acg_dat$fGM/(acg_dat$fGM + acg_dat$fWM)

#plot tissue fraction to check for issues
plot_ACG_tissuefraction <- ggplot(acg_dat, aes(TissueFraction_GMWM))
plot_ACG_tissuefraction+ geom_density() #big skew
plot_ACG_tissuefraction + geom_boxplot() #4 potential outliers
rosnerTest(acg_dat$TissueFraction_GMWM, k = 4)
#4 outliers: Obs. Num 37 (PS14_090), 24 (PS14_050), 93 (PS18_1601), 5 (PS14_009) - double check cogregistration
#PS14_090 is shifted to the left and includes substantial WM - EXCLUDE
#PS14_050 is shifted to the left and T1 quality is poor - EXCLUDE
#PS18_1601 head tilted so voxel captures a bit of WM in the left hemi., a little anterior; doesn't seem terrible
#PS14_009 looks like chin was tipped down toward chest a bit, corner of voxel captures some CC white matter but seems ok

#exclude scans PS14_090 and PS14_050 due to outlier status coregistration issues
acg_dat_tf <- subset(acg_dat, study_code != c("PS14_090", "PS14_050"))

#save database with tissue fraction
write.csv(acg_dat_tf, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_outliers_removed_n112_tissuefraction.csv", row.names = FALSE)

#check correlation between tissue fraction and age
acg_TisFrac_age <- lmer(TissueFraction_GMWM ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_TisFrac_age)
#not sig.

#Add tissue fraction as fixed effect in ACG models
#NAA
#basic age model
acg_naa_age <- lmer(NAA_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_naa_age)

#add tissue fraction
acg_naa_age_tf <- lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_naa_age_tf) #no sig. effect of tissue fraction

#compare models
anova(acg_naa_age, acg_naa_age_tf) #model fit not sig. different

#Cre
#basic age model
acg_cre_age <- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_cre_age)

#add tissue fraction
acg_cre_age_tf <- lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_cre_age_tf)

#compare models
anova(acg_cre_age, acg_cre_age_tf)

#Cho
#basic age model
acg_cho_age <- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_cho_age)

#add tissue fraction
acg_cho_age_tf <- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_cho_age_tf)

#compare models
anova(acg_cho_age, acg_cho_age_tf) #fit not significantly different

#Ins
#basic age model
acg_ins_age <- lmer(Ins_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_ins_age)

#add tissue fraction
acg_ins_age_tf <- lmer(Ins_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_ins_age_tf)

#compare models
anova(acg_ins_age,acg_ins_age_tf) #not sig.

#Glx
#basic age model
acg_glx_age <- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_glx_age)

#add tissue fraction
acg_glx_age_tf <- lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
summary(acg_glx_age_tf)

anova(acg_glx_age, acg_glx_age_tf)

```
##Plot ACG results with 2 tissue fraction outlier subjects excluded
Plotting simple age models run with N=112 subjects

```{r}
#NAA
#pull fixed effects
fixef.acg_naa<-fixef(acg_naa_age)

plot_acg_naa_age<-ggplot(acg_dat_tf, aes(x=mri_age_y, y=NAA_conc_molal,color=as.factor(female))) +
  geom_point() +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "tNAA (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=NAA_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  geom_abline(aes(intercept = fixef.acg_naa[[1]], slope= fixef.acg_naa[[2]])) + 
  theme_classic()
plot_acg_naa_age
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_naa_age_viridis_n112.png")


#Cho
#pull intercept and slope from model for regression line
fixef.acg_cho<-fixef(acg_cho_age)

#plot
plot_acg_cho_age<-ggplot(acg_dat_tf, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal,color=as.factor(female))) + 
  geom_point() +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  geom_abline(aes(intercept = fixef.acg_cho[[1]], slope= fixef.acg_cho[[2]])) + 
  theme_classic()
plot_acg_cho_age
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_cho_age_viridis_n112.png")

#Ins
#pull intercept and slope from model for regression line
fixef.acg_ins<-fixef(acg_ins_age)

#plot
plot_acg_ins_age<-ggplot(acg_dat_tf, aes(x=mri_age_y, y=Ins_conc_molal,color=as.factor(female))) + 
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Ins_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Anterior Cingulate", x = "Age (years)", y = "Ins (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.acg_ins[[1]], slope= fixef.acg_ins[[2]])) + 
  theme_classic()
plot_acg_ins_age
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_ins_age_viridis_n112.png")


```



LAG Tissue Fraction models
```{r}
#LAG
#read in data
lag_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319.csv")

#create tissue fraction variable
lag_dat$TissueFraction_GMWM <- lag_dat$fGM/(lag_dat$fGM + lag_dat$fWM)

#plot tissue fraction to check for issues
plot_LAG_tissuefraction <- ggplot(lag_dat, aes(TissueFraction_GMWM))
plot_LAG_tissuefraction+ geom_density() #normal
plot_LAG_tissuefraction + geom_boxplot() #6 potential outliers
rosnerTest(lag_dat$TissueFraction_GMWM, k = 6) #no significant outliers

write.csv(lag_dat, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319_tissuefraction.csv")

#check correlation between tissue fraction and age
lag_TisFrac_age <- lmer(TissueFraction_GMWM ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_TisFrac_age)
#tissue fraction is significantly negatively associated with age

#in a simple correlation test
cor.test(lag_dat$mri_age_y, lag_dat$TissueFraction_GMWM) #r = -.38


#Add tissue fraction as a fixed effect in LAG models
#basic age model NAA
lag_naa_age<- lmer(NAA_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)

#add tissue fraction
lag_naa_age_TisFrac <- lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_TisFrac)

#compare model fit
anova(lag_naa_age, lag_naa_age_TisFrac) #fit significantly improved

#add tissue fraction interaction with age
lag_naa_age_TisFracXage <- lmer(NAA_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_TisFracXage)
#interaction term for agexTissueFraction not sig.

#compare model fit
anova(lag_naa_age_TisFrac, lag_naa_age_TisFracXage) #not sig., stick with age + TissueFraction model

#add sex to tissue fraction model
lag_naa_age_TisFrac_sex <- lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_TisFrac_sex) #sex not significant

#compare model fit
anova(lag_naa_age_TisFrac, lag_naa_age_TisFrac_sex) #not sig., stick with age + TissueFraction model

#Cre
#basic age model
lag_cre_age<- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age)

#add tissue fraction
lag_cre_age_TisFrac<- lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age_TisFrac)

#compare model fit
anova(lag_cre_age, lag_cre_age_TisFrac) #sig. best model is lag_cre_age_TisFrac

#add interaction
lag_cre_age_TisFrac_int<- lmer(Cre_PCr_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age_TisFrac_int)

#compare model fit
anova(lag_cre_age_TisFrac, lag_cre_age_TisFrac_int) #not sig.

#add sex to tissue fraction model

lag_cre_age_TisFrac_sex<- lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age_TisFrac_sex)

#compare model fit
anova(lag_cre_age_TisFrac, lag_cre_age_TisFrac_sex) #not sig.

#Cho
#basic age model
lag_cho_age<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age)

#add tissue fraction
lag_cho_age_TisFrac<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_TisFrac)

#compare model fit
anova(lag_cho_age, lag_cho_age_TisFrac) #sig

#add interaction
lag_cho_age_TisFrac_int<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_TisFrac_int) #interaction is sig. (p=.047)

#compare model fit
anova(lag_cho_age_TisFrac, lag_cho_age_TisFrac_int) #sig. (p<.046)

#add sex to model
lag_cho_age_TisFrac_int_sex<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y * TissueFraction_GMWM + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_TisFrac_int_sex) #not sig.

#compare model fit
anova(lag_cho_age_TisFrac_int, lag_cho_age_TisFrac_int_sex) #not sig.

#Ins
#basic age model
lag_ins_age<- lmer(Ins_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age)

#add tissue fraction
lag_ins_age_TisFrac<- lmer(Ins_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_TisFrac) #tissue fraction sig.; age not sig.

#compare model fit
anova(lag_ins_age, lag_ins_age_TisFrac) #sig.

#add interaction

lag_ins_age_TisFrac_int<- lmer(Ins_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_TisFrac_int) #tissue fraction, age & interaction all sig.

#compare model fit
anova(lag_ins_age_TisFrac, lag_ins_age_TisFrac_int) #sig.

#add sex
lag_ins_age_TisFrac_int_sex<- lmer(Ins_conc_molal ~ mri_age_y * TissueFraction_GMWM + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_TisFrac_int_sex) #tissue fraction, age & interaction all sig.

#compare model fit
anova(lag_ins_age_TisFrac_int, lag_ins_age_TisFrac_int_sex) #not sig.

#Glx
#basic age model
lag_glx_age<- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age)

#add tissue fraction
lag_glx_age_TisFrac<- lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_TisFrac)

#compare models
anova(lag_glx_age, lag_glx_age_TisFrac) #sig

#add interaction
lag_glx_age_TisFrac_int<- lmer(Glu_Gln_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_TisFrac_int)

#compare models
anova(lag_glx_age_TisFrac, lag_glx_age_TisFrac_int) #not sig

#add sex
lag_glx_age_TisFrac_sex<- lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + female + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_TisFrac_sex)

#compare models
anova(lag_glx_age_TisFrac, lag_glx_age_TisFrac_sex) #not sig

#check models for multicollinearity
library(performance)

check_collinearity(lag_naa_age_TisFrac) #Low
check_collinearity(lag_cre_age_TisFrac) #Low
check_collinearity(lag_cho_age_TisFrac_int) #interaction term causes inflated VIFs - check model without interaction
check_collinearity(lag_cho_age_TisFrac) #Low
check_collinearity(lag_ins_age_TisFrac) #Low
check_collinearity(lag_glx_age_TisFrac) #Low


```

##Unpack interactions
Use sim_slopes function from interactions package to conduct simple slopes analysis on continuous x continuous interactions
```{r}
library(interactions)

#LAG Cho: age x tissue fraction interaction
lag_cho_age_TisFrac_int<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)

#run simple slopes analysis with Johnson-Neyman plot
sim_slopes(lag_cho_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM, jnplot = TRUE)

#save Johnson-Neyman plot
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_int_JNplot.png")

#create interaction plot (make it pretty later)
#basic plot
Cho_age_tf_int_plot <- interact_plot(lag_cho_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM)
Cho_age_tf_int_plot

#linearity check
Cho_age_tf_int_plot_lin <- interact_plot(lag_cho_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM, modx.values="terciles", plot.points=TRUE, linearity.check=TRUE)
Cho_age_tf_int_plot_lin
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_int_linearityplot.png", width = 2000, height = 1500, units = "px")

#seems to be some non-linear effects, try adding quadratic term

#LAG Ins: age x tissue fraction interaction
lag_ins_age_TisFrac_int<- lmer(Ins_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)

#run simple slopes analysis with Johnson-Neyman plot
sim_slopes(lag_ins_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM, jnplot = TRUE)

#save Johnson-Neyman plot
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_int_JNplot.png")

#create interaction plot (make it pretty later)
#basic plot
Ins_age_tf_int_plot <- interact_plot(lag_ins_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM)
Ins_age_tf_int_plot

#linearity check
Ins_age_tf_int_plot_lin <- interact_plot(lag_ins_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM, modx.values="terciles", plot.points=TRUE, linearity.check=TRUE)
Ins_age_tf_int_plot_lin
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_int_linearityplot.png", , width = 2000, height = 1500, units = "px")

#seems to be some non-linear effects - try adding quadratic term


```
##Test quadratic effects of age with tissue fraction covariate in LAG models
Interaction plots showed some nonlinear effects, so testing quadratic effects of age
**Note that these models were run and subsequently discarded because there was not a sufficient N (52/95) of subjects with >2 timepoints to justify the inclusion of polynomial terms and plotting of individual subjects did not show a pattern of needing polynomial fits
```{r}

#create quadratic age variable
lag_dat$mri_age_y2<- (lag_dat$mri_age_y)^2

#NAA
#age + tissue fraction model
lag_naa_age_TisFrac <- lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_TisFrac)

#add quadratic age term with all interactions
lag_naa_age_TisFrac_quad <- lmer(NAA_conc_molal ~ mri_age_y * mri_age_y2 * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_naa_age_TisFrac_quad) #no sig. effects

anova(lag_naa_age_TisFrac, lag_naa_age_TisFrac_quad) #not sig.

#Cre
#age + tissue fraction model
lag_cre_age_TisFrac<- lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age_TisFrac)

#add quadratic age term with all interactions
lag_cre_age_TisFrac_quad<- lmer(Cre_PCr_conc_molal ~ mri_age_y * mri_age_y2 * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cre_age_TisFrac_quad)

#compare models
anova(lag_cre_age_TisFrac, lag_cre_age_TisFrac_quad) #not sig.

#Cho

#age x tissue fraction interaction model
lag_cho_age_TisFrac_int<- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_TisFrac_int) #interaction is sig. (p=.046)

#add quadratic age term with all interactions
lag_cho_age_TisFrac_int_quad <- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y * mri_age_y2 * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_cho_age_TisFrac_int_quad) #no sig. effects

#compare model fit
anova(lag_cho_age_TisFrac_int, lag_cho_age_TisFrac_int_quad) #not sig., stick with age x tissue fraction model

#Ins

#age x tissue fraction interaction model
lag_ins_age_TisFrac_int<- lmer(Ins_conc_molal ~ mri_age_y * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_TisFrac_int) #tissue fraction, age & interaction all sig.

#add quadratic age term with all interactions
lag_ins_age_TisFrac_int_quad<- lmer(Ins_conc_molal ~ mri_age_y * mri_age_y2 * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_ins_age_TisFrac_int_quad) #no sig. effects

anova(lag_ins_age_TisFrac_int, lag_ins_age_TisFrac_int_quad) #not sig.

#Glx
#age + tissue fraction model
lag_glx_age_TisFrac<- lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_TisFrac)

#add quadratic age term with all interactions
lag_glx_age_TisFrac_quad<- lmer(Glu_Gln_conc_molal ~ mri_age_y * mri_age_y2 * TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
summary(lag_glx_age_TisFrac_quad) #no sig. effects
#warning: boundary fit is singular

#compare models
anova(lag_glx_age_TisFrac, lag_glx_age_TisFrac_quad)  #significant 

```


##Print model summaries 
Print formatted model summaries and tables using report and sjplot package
```{r}
library(sjPlot) #for pretty summary tables
library(report) #for text summaries

#create html summary table for sig. models ACG
acg_summary_table_sig<-tab_model(acg_naa_age, acg_cho_age, acg_ins_age, dv.labels = c("tNAA (molal)", "tCho (molal)", "Ins (molal)"), pred.labels = c("(Intercept)", "Age (years)"))
acg_summary_table_sig #opens in Rstudio viewer, can open from there to web browser and save as PDF or whatever

#create html summary table for all models ACG
acg_summary_table_all<-tab_model(acg_naa_age, acg_cre_age, acg_cho_age, acg_ins_age, acg_glx_age, show.std = TRUE, show.re.var=FALSE, show.icc = FALSE, show.r2=FALSE, dv.labels = c("tNAA (molal)", "tCre (molal)", "tCho (molal)", "Ins (molal)", "Glx (molal)"), pred.labels = c("(Intercept)", "Age (years)"))
acg_summary_table_all #opens in Rstudio viewer, can open from there to web browser and save as PDF or whatever


#output text summaries for ACG models
report(acg_naa_age)
report(acg_cre_age)
report(acg_cho_age)
report(acg_ins_age)
report(acg_glx_age)

#create html summary table for sig. models LAG
lag_summary_table_sig<-tab_model(lag_naa_age_TisFrac, lag_cre_age_TisFrac, lag_cho_age_TisFrac_int, lag_ins_age_TisFrac_int, show.re.var=FALSE, show.icc = FALSE, show.r2=FALSE, dv.labels = c("tNAA (molal)", "tCre (molal)", "tCho (molal)", "Ins (molal)"), pred.labels = c("(Intercept)", "Age (years)", "Tissue Fraction GM/(WM+GM)", "Age:Tissue Fraction"))
lag_summary_table_sig

#create html summary table for all models LAG
lag_summary_table_all<-tab_model(lag_naa_age_TisFrac, lag_cre_age_TisFrac, lag_cho_age_TisFrac, lag_ins_age_TisFrac, lag_glx_age_TisFrac, show.std = TRUE, show.re.var=FALSE, show.icc = FALSE, show.r2=FALSE, dv.labels = c("tNAA (molal)", "tCre (molal)", "tCho (molal)", "Ins (molal)", "Glx (molal)"), pred.labels = c("(Intercept)", "Age (years)", "Tissue Fraction GM/(WM+GM)"))
lag_summary_table_all

report(lag_naa_age_TisFrac)
report(lag_cre_age_TisFrac)
report(lag_cho_age_TisFrac)
report(lag_ins_age_TisFrac)
report(lag_glx_age_TisFrac)

#Glx models - unpacking for interpretation
glx_tf_sum<-tab_model(lag_glx_age_TisFrac)
glx_tf_sum

glx_tf_quad_sum<-tab_model(lag_glx_age_TisFrac_quad)
glx_tf_quad_sum
```
##Plot results of models including tissue fraction
Estimate metabolite residuals using remef
Include individual slopes (estimated via linear models by subject) using geom_smooth()
Include overall fit line using geom_abline
```{r}
#LAG - NAA

#pull fixed effects for overall model
fixef.lag_naa_TisFrac<-fixef(lag_naa_age_TisFrac)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot<- lag_dat %>% 
  filter(! is.na(NAA_conc_molal))

#calculate partial effect of age on tNAA (remove effect of tissue fraction)
lag_naa_partial <- remef(lag_naa_age_TisFrac, fix = "TissueFraction_GMWM") #does NOT remove random effects variance

#create plot to show NAA ~ age while controlling for Tissue Fraction
plot_lag_naa_age_tf<-ggplot(lag_dat_plot, aes(x=mri_age_y, y=lag_naa_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_naa_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tNAA | Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_naa_TisFrac[[1]], slope = fixef.lag_naa_TisFrac[[2]])) + 
  theme_classic()
plot_lag_naa_age_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_naa_age_partialef.png")


#LAG - Cre

#pull fixed effects for overall model
fixef.lag_cre_age_TisFrac<-fixef(lag_cre_age_TisFrac)

#subset dataframe with only subjects included in Cre analysis
lag_dat_plot_Cre<- lag_dat %>% 
  filter(! is.na(Cre_PCr_conc_molal))

#calculate partial effect of age on Cre (remove effect of tissue fraction)
lag_cre_partial <- remef(lag_cre_age_TisFrac, fix = "TissueFraction_GMWM") #does NOT remove random effects variance

plot_lag_cre_age_tf<-ggplot(lag_dat_plot_Cre, aes(x=mri_age_y, y=lag_cre_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_cre_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tCre | Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_cre_age_TisFrac[[1]], slope = fixef.lag_cre_age_TisFrac[[2]])) + 
  theme_classic()
plot_lag_cre_age_tf
  ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cre_age_partialef.png")


#LAG - Cho
#pull fixed effects for overall model
fixef.lag_cho_age_TisFrac<-fixef(lag_cho_age_TisFrac)

#subset dataframe with only subjects included in Cre analysis
lag_dat_plot_cho<- lag_dat %>% 
  filter(! is.na(Cho_GPC_PCh_conc_molal))

#calculate partial effect of age on Cre (remove effect of tissue fraction)
lag_cho_partial <- remef(lag_cho_age_TisFrac, fix = "TissueFraction_GMWM") #does NOT remove random effects variance

plot_lag_cho_age_tf<-ggplot(lag_dat_plot_cho, aes(x=mri_age_y, y=lag_cho_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_cho_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tCho | Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_cho_age_TisFrac[[1]], slope = fixef.lag_cho_age_TisFrac[[2]])) + 
  theme_classic()
plot_lag_cho_age_tf
  ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_partialef.png")
  
  
#interaction plot
Cho_age_tf_int_plot <- interact_plot(lag_cho_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM, data=lag_dat, plot.points=TRUE, legend.main="Tissue Fraction GM/(GM+WM)", modx.labels=c(".535 (-1 SD)", ".642 (Mean)", ".750 (+1 SD)")) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "tCho (molal)") + 
  scale_color_viridis(option="mako", name="Tissue Fraction GM/(GM+WM)", begin= .32, end=.85) +
  theme_classic()
Cho_age_tf_int_plot
  ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_int.png")


#LAG - Ins
#Tissue fraction only model
#pull fixed effects for overall interaction model
fixef.lag_ins_age_TisFrac<-fixef(lag_ins_age_TisFrac)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot_Ins<- lag_dat %>% 
  filter(! is.na(Ins_conc_molal))

#calculate partial effect of age on Ins (remove effect of tissue fraction)
lag_ins_partial <- remef(lag_ins_age_TisFrac, fix = c("TissueFraction_GMWM")) #does NOT remove random effects variance

#plot main effect of age controlling for tissue fraction and age x tissue fraction interaction
plot_lag_ins_age_tf<-ggplot(lag_dat_plot_Ins, aes(x=mri_age_y, y=lag_ins_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_ins_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "Ins | Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_ins_age_TisFrac[[1]], slope = fixef.lag_ins_age_TisFrac[[2]])) + 
  theme_classic()
plot_lag_ins_age_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_partialef.png")


  
#Main effect of age 
#pull fixed effects for overall interaction model
fixef.lag_ins_age_TisFrac_int<-fixef(lag_ins_age_TisFrac_int)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot_Ins<- lag_dat %>% 
  filter(! is.na(Ins_conc_molal))

#calculate partial effect of age on Ins (remove effect of tissue fraction)
lag_ins_partial <- remef(lag_ins_age_TisFrac_int, fix = c("TissueFraction_GMWM","mri_age_y:TissueFraction_GMWM")) #does NOT remove random effects variance

#plot main effect of age controlling for tissue fraction and age x tissue fraction interaction
plot_lag_ins_age_tf<-ggplot(lag_dat_plot_Ins, aes(x=mri_age_y, y=lag_ins_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_ins_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "Ins | Tissue Fraction and Tissue Fraction:Age") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_ins_age_TisFrac_int[[1]], slope = fixef.lag_ins_age_TisFrac_int[[2]])) + 
  theme_classic()
plot_lag_ins_age_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_maineffect.png")

  
#age x tissue fraction interaction plot
Ins_age_tf_int_plot <- interact_plot(lag_ins_age_TisFrac_int, pred = mri_age_y, modx = TissueFraction_GMWM, data=lag_dat, plot.points=TRUE, legend.main="Tissue Fraction GM/(GM+WM)", modx.labels=c(".535 (-1 SD)", ".642 (Mean)", ".750 (+1 SD)")) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "Ins (molal)") +
  scale_color_viridis(option="mako", name="Tissue Fraction GM/(GM+WM)", begin= .32, end=.85) +
  theme_classic()
Ins_age_tf_int_plot #only the slope for the lowest range of tissue fraction values (-1 SD) is significant 
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_int.png")

#Glx - simple age + tf model
#pull fixed effects for overall model
fixef.lag_glx_TisFrac<-fixef(lag_glx_age_TisFrac)

#subset dataframe with only subjects included in Glx analysis
lag_glx_plot<- lag_dat %>% 
  filter(! is.na(Glu_Gln_conc_molal))

#calculate partial effect of age on Glx (remove effect of tissue fraction)
lag_glx_partial <- remef(lag_glx_age_TisFrac, fix = "TissueFraction_GMWM") #does NOT remove random effects variance

#create plot to show Glx ~ age while controlling for Tissue Fraction
plot_lag_glx_age_tf<-ggplot(lag_glx_plot, aes(x=mri_age_y, y=lag_glx_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_glx_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "Glx | Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_glx_TisFrac[[1]], slope = fixef.lag_glx_TisFrac[[2]])) + 
  theme_classic()
plot_lag_glx_age_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_glx_age_partialef.png")

#Plot Glx by Tissue fraction controlling for age
lag_glx_partial_tf <- remef(lag_glx_age_TisFrac, fix = "mri_age_y") #does NOT remove random effects variance
lag_glx_subset <- lag_glx_plot %>% 
  filter(! is.na(Glu_Gln_conc_molal))
plot_lag_glx_tf_partAge<-ggplot(lag_glx_plot, aes(x=TissueFraction_GMWM, y=lag_glx_partial_tf, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=lag_glx_partial_tf, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Tissue Fraction GM/(GM+WM)", y = "Glx | Age") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_glx_TisFrac[[1]], slope = fixef.lag_glx_TisFrac[[3]])) + 
  theme_classic()
plot_lag_glx_tf_partAge
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_glx_tf_partialef.png")

#plot a subset of individuals' data to see whether quadratic fit makes sense to include in model
#create random subset from individuals with >=3 time points
#list all subjects with >2 time points
lag_glx_long<-group_by(lag_glx_plot, subj_id) %>%
  summarise(n=n()) %>%
  filter(n > 2)

#randomly select 36 of those subjects
set.seed(56789)
lag_glx_randsample<- sample_n(lag_glx_long, 36)

#create data subset with those 30 subjects for plotting
lag_glx_plot36 <- lag_glx_plot %>%
                    filter(subj_id %in% lag_glx_randsample$subj_id)

#plot individual subject data by faceting
plot_lag_glx_indiv<-ggplot(lag_glx_plot36, aes(x=mri_age_y, y=Glu_Gln_conc_molal, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  facet_wrap(~subj_id) +
  geom_smooth() +
  labs(title = "Left Temporo-Parietal", x = "Age (years)", y = "Glx") +
  scale_y_continuous(limits = c(5,30), breaks = seq(5,30,5)) +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  theme_classic()
plot_lag_glx_indiv
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_glx_individ_n36.png", plot = plot_lag_glx_indiv)

```
#Plotting tissue fraction effects in LAG
```{r}
#read in data with tissue fraction
lag_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319_tissuefraction.csv")

#LAG - NAA
#pull fixed effects for overall model
fixef.lag_naa_TisFrac<-fixef(lag_naa_age_TisFrac)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot<- lag_dat %>% 
  filter(! is.na(NAA_conc_molal))

#calculate partial effect tissue fraction on tNAA (remove effect of age)
lag_naa_tf_partial <- remef(lag_naa_age_TisFrac, fix = "mri_age_y") #does NOT remove random effects variance

#create plot to show NAA ~ age while controlling for Tissue Fraction
plot_lag_naa_tf<-ggplot(lag_dat_plot, aes(x=TissueFraction_GMWM, y=lag_naa_tf_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=lag_naa_tf_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Tissue Fraction GM/(GM+WM)", y = "tNAA | Age") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_y_continuous(limits = c(1,18), breaks = seq(1,18,1)) +
  geom_abline(aes(intercept = fixef.lag_naa_TisFrac[[1]], slope = fixef.lag_naa_TisFrac[[3]])) + 
  theme_classic()
plot_lag_naa_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_naa_tf_partialef.png")


#LAG - Cre

#pull fixed effects for overall model
fixef.lag_cre_age_TisFrac<-fixef(lag_cre_age_TisFrac)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot_Cre<- lag_dat %>% 
  filter(! is.na(Cre_PCr_conc_molal))

#calculate partial effect of age on Cre (remove effect of tissue fraction)
lag_cre_tf_partial <- remef(lag_cre_age_TisFrac, fix = "mri_age_y") #does NOT remove random effects variance

plot_lag_cre_age_tf<-ggplot(lag_dat_plot_Cre, aes(x=TissueFraction_GMWM, y=lag_cre_tf_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=lag_cre_tf_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Tissue Fraction GM/(GM+WM)", y = "tCre | Age") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_y_continuous(limits = c(1,18), breaks = seq(1,18,1)) +
  geom_abline(aes(intercept = fixef.lag_cre_age_TisFrac[[1]], slope = fixef.lag_cre_age_TisFrac[[3]])) + 
  theme_classic()
plot_lag_cre_age_tf
  ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cre_tf_partialef.png")

#LAG - Cho

#interaction model
#pull fixed effects for overall model
fixef.lag_cho_age_TisFrac_int<-fixef(lag_cho_age_TisFrac_int)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot_cho<- lag_dat %>% 
  filter(! is.na(Cho_GPC_PCh_conc_molal))

#calculate partial effect of age on Cre (remove effect of tissue fraction)
lag_cho_tf_partial <- remef(lag_cho_age_TisFrac_int, fix = c("mri_age_y", "mri_age_y:TissueFraction_GMWM")) #does NOT remove random effects variance

plot_lag_cho_tf<-ggplot(lag_dat_plot_cho, aes(x=TissueFraction_GMWM, y=lag_cho_tf_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=lag_cho_tf_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Tissue Fraction GM/(GM+WM)", y = "tCho | Age + Age:Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_y_continuous(limits = c(1,18), breaks = seq(1,18,1)) +
  geom_abline(aes(intercept = fixef.lag_cho_age_TisFrac_int[[1]], slope = fixef.lag_cho_age_TisFrac_int[[3]])) + 
  theme_classic()
plot_lag_cho_tf
  ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_tf_partialef.png")

#LAG - Ins
#Main effect of age 
 #pull fixed effects for overall model
fixef.lag_ins_age_TisFrac_int<-fixef(lag_ins_age_TisFrac_int)

#subset dataframe with only subjects included in NAA analysis
lag_dat_plot_Ins<- lag_dat %>% 
  filter(! is.na(Ins_conc_molal))

#calculate partial effect of age on Ins (remove effect of tissue fraction)
lag_ins_tf_partial <- remef(lag_ins_age_TisFrac_int, fix = c("mri_age_y","mri_age_y:TissueFraction_GMWM")) #does NOT remove random effects variance

#plot main effect of age controlling for tissue fraction and age x tissue fraction interaction
plot_lag_ins_tf<-ggplot(lag_dat_plot_Ins, aes(x=TissueFraction_GMWM, y=lag_ins_tf_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=lag_ins_tf_partial, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "Tissue Fraction GM/(GM+WM)", y = "Ins | Age and Age:Tissue Fraction") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_y_continuous(limits = c(1,18), breaks = seq(1,18,1)) +
  geom_abline(aes(intercept = fixef.lag_ins_age_TisFrac_int[[1]], slope = fixef.lag_ins_age_TisFrac_int[[3]])) + 
  theme_classic()
plot_lag_ins_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_maineffect.png")
```

##more descriptive plots to explore age x tissue fraction interactions
```{r}
#plot tissue fraction by age
fixef.lag_TisFrac_age<-fixef(lag_TisFrac_age)

plot_lag_age_tf<-ggplot(lag_dat, aes(x=mri_age_y, y=TissueFraction_GMWM, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=TissueFraction_GMWM, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Full Sample (n=319)", x = "Age (years)", y = "Tissue Fraction GM/(GM+WM)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  geom_abline(aes(intercept = fixef.lag_TisFrac_age[[1]], slope = fixef.lag_TisFrac_age[[2]])) + 
  theme_classic()
plot_lag_age_tf
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_age_tf.png", plot=plot_lag_age_tf)

#split dataset into age groups: 2-5.9, 6-12
lag_dat_young<-lag_dat %>% filter(mri_age_y< 6)
lag_dat_old<-lag_dat %>% filter(mri_age_y >= 6)

#model tissue fraction by age in young group
lag_TisFrac_age_young<-lmer(TissueFraction_GMWM ~ mri_age_y + (1 | subj_id), data=lag_dat_young, REML=FALSE)
summary(lag_TisFrac_age_young)

fixef.lag_TisFrac_age_young<-fixef(lag_TisFrac_age_young)

plot_lag_age_tf_young<-ggplot(lag_dat_young, aes(x=mri_age_y, y=TissueFraction_GMWM, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=TissueFraction_GMWM, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Ages 2-5.9 (n=185)", x = "Age (years)", y = "Tissue Fraction GM/(GM+WM)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(2,6), breaks=seq(2,6,1)) +
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  geom_abline(aes(intercept = fixef.lag_TisFrac_age_young[[1]], slope = fixef.lag_TisFrac_age_young[[2]])) + 
  theme_classic()
plot_lag_age_tf_young
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_age_tf_young.png", plot=plot_lag_age_tf_young)

#model tissue fraction by age in old group
lag_TisFrac_age_old<-lmer(TissueFraction_GMWM ~ mri_age_y + (1 | subj_id), data=lag_dat_old, REML=FALSE)
summary(lag_TisFrac_age_old)

fixef.lag_TisFrac_age_old<-fixef(lag_TisFrac_age_old)

plot_lag_age_tf_old<-ggplot(lag_dat_old, aes(x=mri_age_y, y=TissueFraction_GMWM, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=TissueFraction_GMWM, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Ages 6-11, n=134", x = "Age (years)", y = "Tissue Fraction GM/(GM+WM)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(6,12), breaks=seq(6,12,1)) +
  scale_y_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  geom_abline(aes(intercept = fixef.lag_TisFrac_age_old[[1]], slope = fixef.lag_TisFrac_age_old[[2]])) + 
  theme_classic()
plot_lag_age_tf_old
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_age_tf_old.png", plot=plot_lag_age_tf_old)


#pull tissue fraction x age plots into a single figure
library(patchwork)
tf_by_age_fig<-plot_lag_age_tf + plot_lag_age_tf_young + plot_lag_age_tf_old + plot_layout(nrow=1, guides='collect')
tf_by_age_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_tf_by_age.png", tf_by_age_fig, width = 3000, height = 1500, units = "px")

#plot overall tissue fraction difference between age groups
#create a variable to split the data into age groups
lag_dat$old<-ifelse(lag_dat$mri_age_y>=6, 1, 0)
tf_violin<-ggplot(lag_dat, aes(x=as.factor(old), y=TissueFraction_GMWM)) +
          geom_violin() +
          scale_y_continuous(limits=c(0,1)) +
          stat_summary(fun.data="mean_sdl")
tf_violin


#Model & plot Cho relationship with tissue fraction split by age groups

#model Cho by tissue fraction  in young group
lag_Cho_tf_young<-lmer(Cho_GPC_PCh_conc_molal ~ TissueFraction_GMWM + (1 | subj_id), data=lag_dat_young, REML=FALSE)
summary(lag_Cho_tf_young)

fixef.lag_Cho_tf_young<-fixef(lag_Cho_tf_young)

plot_lag_Cho_tf_young<-ggplot(lag_dat_young, aes(x=TissueFraction_GMWM, y=Cho_GPC_PCh_conc_molal, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=Cho_GPC_PCh_conc_molal, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Ages 2-5.9 (n=185)", x = "Tissue Fraction GM/(GM+WM)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  scale_y_continuous(limits=c(0,4), breaks=seq(0,4,1)) +
  geom_abline(aes(intercept = fixef.lag_Cho_tf_young[[1]], slope = fixef.lag_Cho_tf_young[[2]])) + 
  theme_classic()
plot_lag_Cho_tf_young


#model Cho by tissue fraction in old group
lag_Cho_tf_old<-lmer(Cho_GPC_PCh_conc_molal ~ TissueFraction_GMWM + (1 | subj_id), data=lag_dat_old, REML=FALSE)
summary(lag_Cho_tf_old)

fixef.lag_Cho_tf_old<-fixef(lag_Cho_tf_old)

plot_lag_Cho_tf_old<-ggplot(lag_dat_old, aes(x=TissueFraction_GMWM, y=Cho_GPC_PCh_conc_molal, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=Cho_GPC_PCh_conc_molal, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Ages 6-11 (n=134)", x = "Tissue Fraction GM/(GM+WM)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  scale_y_continuous(limits=c(0,4), breaks=seq(0,4,1)) +
  geom_abline(aes(intercept = fixef.lag_Cho_tf_old[[1]], slope = fixef.lag_Cho_tf_old[[2]])) + 
  theme_classic()
plot_lag_Cho_tf_old

#pull Cho by tissue fraction plots into a fig
Cho_by_tf_agegroup_fig<-plot_lag_Cho_tf_young + plot_lag_Cho_tf_old + plot_layout(nrow=1, guides='collect')
Cho_by_tf_agegroup_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_by_tf_agegroups.png", Cho_by_tf_agegroup_fig, width = 2000, height = 1000, units = "px")


##Model & plot Ins relationship with tissue fraction split by age groups

#model Ins by tissue fraction  in young group
lag_Ins_tf_young<-lmer(Ins_conc_molal ~ TissueFraction_GMWM + (1 | subj_id), data=lag_dat_young, REML=FALSE)
summary(lag_Ins_tf_young)

fixef.lag_Ins_tf_young<-fixef(lag_Ins_tf_young)

plot_lag_Ins_tf_young<-ggplot(lag_dat_young, aes(x=TissueFraction_GMWM, y=Ins_conc_molal, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=Ins_conc_molal, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Ages 2-5.9 (n=185)", x = "Tissue Fraction GM/(GM+WM)", y = "Ins (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  scale_y_continuous(limits=c(0,12), breaks=seq(0,12,1)) +
  geom_abline(aes(intercept = fixef.lag_Ins_tf_young[[1]], slope = fixef.lag_Ins_tf_young[[2]])) + 
  theme_classic()
plot_lag_Ins_tf_young


#model Ins by tissue fraction in old group
lag_Ins_tf_old<-lmer(Ins_conc_molal ~ TissueFraction_GMWM + (1 | subj_id), data=lag_dat_old, REML=FALSE)
summary(lag_Ins_tf_old)

fixef.lag_Ins_tf_old<-fixef(lag_Ins_tf_old)

plot_lag_Ins_tf_old<-ggplot(lag_dat_old, aes(x=TissueFraction_GMWM, y=Ins_conc_molal, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female))) +
  geom_smooth(method = "lm", se = FALSE, aes(x=TissueFraction_GMWM, y=Ins_conc_molal, color=as.factor(female), group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Ages 6-11 (n=134)", x = "Tissue Fraction GM/(GM+WM)", y = "Ins (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  scale_x_continuous(limits=c(0,1), breaks=seq(0,1,.1)) +
  scale_y_continuous(limits=c(0,12), breaks=seq(0,12,1)) +
  geom_abline(aes(intercept = fixef.lag_Ins_tf_old[[1]], slope = fixef.lag_Ins_tf_old[[2]])) + 
  theme_classic()
plot_lag_Ins_tf_old

#pull Ins by tissue fraction plots into a fig
Ins_by_tf_agegroup_fig<-plot_lag_Ins_tf_young + plot_lag_Ins_tf_old + plot_layout(nrow=1, guides='collect')
Ins_by_tf_agegroup_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_Ins_by_tf_agegroups.png", Ins_by_tf_agegroup_fig, width = 2000, height = 1000, units = "px")

```


##Edit plots for manuscript
rescale plots to consistent scale, adjust legends, remove individual titles, join plots as panels in figures
*Run tissue fractions models and "Plot results of models including tissue fraction" chunks before running this chunk
```{r}
#ACG plots - main effects only
ACG_NAA<-plot_acg_naa_age +
  scale_x_continuous(limits=c(2,8), breaks=seq(2,8,1)) +
  scale_y_continuous(limits=c(1,19), breaks=seq(1,19,1)) +
  theme(legend.position='none') +
  labs(title=NULL)
ACG_NAA
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_naa_age_n112_rescale.png")

ACG_Cho<-plot_acg_cho_age +
  scale_x_continuous(limits=c(2,8), breaks=seq(2,8,1)) +
  scale_y_continuous(limits=c(1,19), breaks=seq(1,19,1)) +
  theme(legend.position=c(.8,.9), legend.background = element_rect(fill="transparent", linetype = NULL)) +
  labs(title=NULL)
ACG_Cho
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_cho_age_n112_rescale.png")

ACG_Ins<-plot_acg_ins_age +
  scale_x_continuous(limits=c(2,8), breaks=seq(2,8,1)) +
  scale_y_continuous(limits=c(1,19), breaks=seq(1,19,1)) +
  theme(legend.position=c(.8,.9), legend.background = element_rect(fill="transparent", linetype = NULL)) +
  labs(title=NULL)
ACG_Ins
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_ins_age_n112_rescale.png")

#Join ACG main effects plots in a single figure
library(patchwork)
ACG_fig<-ACG_NAA + ACG_Cho + plot_layout(nrow=1) + plot_annotation(title = 'Relationships between age and metabolite concentrations in ACC')
ACG_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/ACG__NAA_Cho_maineffects_fig_grid_viridis.png", ACG_fig, width = 2000, height = 1500, units = "px")

#edit dot & line sizes, try different scale
#ACG plots - main effects only

#NAA
#pull fixed effects
fixef.acg_naa<-fixef(acg_naa_age)

ACG_NAA<-ggplot(acg_dat_tf, aes(x=mri_age_y, y=NAA_conc_molal,color=as.factor(female))) +
  geom_point(size=1) +
  labs(x = "Age (years)", y = "tNAA (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=NAA_conc_molal, group=as.factor(subj_id)), size = .5, show.legend = FALSE) +
  geom_abline(aes(intercept = fixef.acg_naa[[1]], slope= fixef.acg_naa[[2]]), size=1) + 
  scale_x_continuous(limits=c(2,8), breaks=seq(2,8,1)) +
  scale_y_continuous(limits=c(10,20), breaks=seq(10,20,1)) +
  theme_classic(base_size = 14) +
  theme(legend.position='none') 
ACG_NAA

ggsave(plot = ACG_NAA, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_naa_age_n112_rescale_v2.png")

#Cho
#pull intercept and slope from model for regression line
fixef.acg_cho<-fixef(acg_cho_age)

#plot
ACG_Cho<-ggplot(acg_dat_tf, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal,color=as.factor(female))) + 
  geom_point(size=1) +
  labs(x = "Age (years)", y = "tCho (molal)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=Cho_GPC_PCh_conc_molal, group=as.factor(subj_id)), size = .5, show.legend = FALSE) +
  geom_abline(aes(intercept = fixef.acg_cho[[1]], slope= fixef.acg_cho[[2]]), size=1) + 
  scale_x_continuous(limits=c(2,8), breaks=seq(2,8,1)) +
  scale_y_continuous(limits=c(0,10), breaks=seq(0,10,1)) +
  theme_classic(base_size = 14) +
  theme(legend.position=c(.8,.9), legend.background = element_rect(fill="transparent", linetype = NULL)) 
ACG_Cho

ggsave(plot=ACG_Cho,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_cho_age_viridis_n112_v2.png")


#Join updated ACG main effects plots in a single figure
library(patchwork)
ACG_fig<-ACG_NAA + ACG_Cho + plot_layout(nrow=1)
ACG_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/ACG__NAA_Cho_maineffects_fig_grid_viridis_v2.png", ACG_fig, width = 2000, height = 1500, units = "px")

#rescaling again - ACG

ACG_NAA_v3<- ACG_NAA +
  scale_y_continuous(limits=c(11,19), breaks=seq(11,29,1))
ACG_NAA_v3

ACG_Cho_v3 <- ACG_Cho +
  scale_y_continuous(limits=c(1,4), breaks=seq(1,24,1))
ACG_Cho_v3

ACG_fig_v3<-ACG_NAA_v3 + ACG_Cho_v3 + plot_layout(nrow=1)
ACG_fig_v3

ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/ACG__NAA_Cho_maineffects_fig_grid_viridis_v3.png", ACG_fig_v3, width = 2000, height = 1500, units = "px")



#read data LAG
lag_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319_tissuefraction.csv")

#LAG - NAA
#Main effect plots for LAG
#rescale plot to show NAA ~ age while controlling for Tissue Fraction
LAG_NAA<-plot_lag_naa_age_tf + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(1,18), breaks=seq(1,18,1)) +
  theme(legend.position='none') +
  labs(title=NULL)
LAG_NAA
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_naa_age_partialef_rescale.png")

#rescale plot to show Cho ~ age while controlling for Tissue Fraction
LAG_Cho<-plot_lag_cho_age_tf + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(1,18), breaks=seq(1,18,1)) +
  theme(legend.position='none') +
  labs(title=NULL)
LAG_Cho
 ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_int_rescale.png")

#LAG - Cre
LAG_Cre<-plot_lag_cre_age_tf +
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(1,18), breaks=seq(1,18,1)) +
  theme(legend.position=c(.8,.9), legend.background = element_rect(fill="transparent", linetype = NULL)) +
  labs(title=NULL)
LAG_Cre  
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cre_age_partialef_rescale.png")


#Join LAG main effects plots in a single figure
library(patchwork)
LAG_fig<-LAG_NAA + LAG_Cho + LAG_Cre + plot_layout(nrow=1) + plot_annotation(title = 'Relationships between age and metabolite concentrations in LTP')
LAG_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/LAG_age_effects_fig_grid_viridis.png", LAG_fig, width = 3000, height = 1500, units = "px")

#interaction plots
#LAG - Cho
LAG_Cho<-Cho_age_tf_plot +
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(0,4), breaks=seq(1,4,1)) +
  labs(title=NULL)
LAG_Cho_int
  ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_int_rescale.png")


#LAG - Ins age x tissue fraction interaction plot
#how to indicate in plot that only the -1 SD line is significant?
LAG_Ins_int<-Ins_age_tf_int_plot +
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(0,12), breaks=seq(1,12,1)) +
  labs(title=NULL)
LAG_Ins_int
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_ins_age_tf_int_rescale.png")

#Join interaction plots into a single figure
LAG_int_fig<- LAG_Cho_int + LAG_Ins_int + plot_layout(nrow=1, guides = 'collect') + plot_annotation(title='Age x tissue fraction interactions in left temporo-parietal region')
LAG_int_fig

ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/LAG_interactions_fig_grid_viridis.png", LAG_int_fig, width = 3000, height = 1500, units = "px")

##editing plots for manuscript - LTP

#create plot to show NAA ~ age while controlling for Tissue Fraction
LAG_NAA<-ggplot(lag_dat_plot, aes(x=mri_age_y, y=lag_naa_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point(size=1) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_naa_partial, group=as.factor(subj_id)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "tNAA (corrected for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_naa_TisFrac[[1]], slope = fixef.lag_naa_TisFrac[[2]]), size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(8,18), breaks=seq(8,18,1)) +
  theme_classic(base_size = 14) +
  theme(legend.position='none')
LAG_NAA
ggsave(plot=LAG_NAA,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_naa_age_tf_rescale_v2.png")


#calculate partial effect of age on Cre (remove effect of tissue fraction)
lag_cho_partial <- remef(lag_cho_age_TisFrac, fix = "TissueFraction_GMWM") #does NOT remove random effects variance

LAG_Cho<-ggplot(lag_dat_plot_cho, aes(x=mri_age_y, y=lag_cho_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point(size=1) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_cho_partial, group=as.factor(subj_id)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "tCho (corrected for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_cho_age_TisFrac[[1]], slope = fixef.lag_cho_age_TisFrac[[2]]), size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(0,10), breaks=seq(0,10,1)) +
  theme_classic(base_size=14) +
  theme(legend.position='none')
LAG_Cho
ggsave(plot=LAG_Cho,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_age_tf_rescale_v2.png")


#calculate partial effect of age on Cre (remove effect of tissue fraction)
lag_cre_partial <- remef(lag_cre_age_TisFrac, fix = "TissueFraction_GMWM") #does NOT remove random effects variance

LAG_Cre<-ggplot(lag_dat_plot_Cre, aes(x=mri_age_y, y=lag_cre_partial, na.exclude = TRUE, color=as.factor(female))) +
  geom_point(size=1) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_cre_partial, group=as.factor(subj_id)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "tCre (corrected for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_cre_age_TisFrac[[1]], slope = fixef.lag_cre_age_TisFrac[[2]]), size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(3,13), breaks=seq(3,13,1)) +
  theme_classic(base_size=14) +
  theme(legend.position =c(.8,.9), legend.background = element_rect(fill="transparent", linetype = NULL))
LAG_Cre
ggsave(plot=LAG_Cre,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cre_age_tf_rescale_v2.png")

LAG_fig<-LAG_NAA + LAG_Cho + LAG_Cre + plot_layout(nrow=1) 
LAG_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/LAG_age_effects_fig_grid_viridis_v2.png", LAG_fig, width = 3000, height = 1500, units = "px")


#rescaling again
LAG_NAA_v3<-LAG_NAA +
  scale_y_continuous(limits=c(8,17), breaks=seq(8,17,1)) 
LAG_NAA_v3

LAG_Cho_v3<-LAG_Cho +
  scale_y_continuous(limits=c(1,4), breaks=seq(1,4,1)) 
LAG_Cho_v3

LAG_Cre_v3<-LAG_Cre +
  scale_y_continuous(limits=c(4,12), breaks=seq(4,12,1)) 
LAG_Cre_v3

LAG_fig_v3<-LAG_NAA_v3 + LAG_Cho_v3 + LAG_Cre_v3 + plot_layout(nrow=1) 
LAG_fig_v3
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/LAG_age_effects_fig_grid_viridis_v3.png", LAG_fig_v3, width = 3000, height = 1500, units = "px")

```
##FDR Correction for multiple comparisons: final models
run FDR correction (Benjamini & Hochberg method) on final models (simple growth models for ACG, tissue fraction models for LAG)
Following Reynolds et al. 2019 NeuroImage - correct for multiple comparisons within a given factor (e.g. age) across models. Correcting within ACG and LTP separately as they are separate data sets
```{r}
#ACG
#list models
models_acg<- c(acg_naa_age, acg_cre_age, acg_cho_age, acg_ins_age, acg_glx_age)

#list p-values for age in each model
p_acg<-models_acg %>%
  map(summary) %>%
  map(coef) %>%
  map_dbl(10) #index of p-val for age in coef list

model_names<-c("NAA", "Cre", "Cho", "Ins", "Glx")
fdr_table_acg<-data.frame(model_names, p_acg)

fdr_table_acg$p_fdr<-p.adjust(p_acg, method = "fdr", n=length(p_acg))
colnames(fdr_table_acg)<- c("Metabolite", "p, unc.", "p, FDR")

write.csv(fdr_table_acg, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/fdr_table_acg_age.csv")


#LAG

#age + tf models
models_lag<-c(lag_naa_age_TisFrac, lag_cre_age_TisFrac, lag_glx_age_TisFrac)

#interaction models
models_lag_int<-c(lag_cho_age_TisFrac_int, lag_ins_age_TisFrac_int)

#list p-values for age in age + tf models, 
p_lag_age<-models_lag %>%
  map(summary) %>%
  map(coef) %>%
  map(14) #index of p-val for age in coef list

#list p-values for age in interaction models 
p_lag_age_int<-models_lag_int %>%
  map(summary) %>%
  map(coef) %>%
  map(18) #index of p-val for age in coef list including interaction term


model_names_lag<-c("NAA", "Cre", "Glx", "Cho", "Ins") #arranged to match order of models listed 

#combine lists of p-values from models
p_lag_age_all<-unlist(c(p_lag_age, p_lag_age_int))

#run FDR correction
p_fdr_lag<-p.adjust(p_lag_age_all, method = "fdr", n=length(p_lag_age_all))

#create dataframe for output
fdr_table_lag<-data.frame(model_names_lag, p_lag_age_all, p_fdr_lag)

colnames(fdr_table_lag)<- c("Metabolite", "p, unc.", "p, FDR")

write.csv(fdr_table_lag, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/fdr_table_lag_age.csv")

#decided to exclude age X TF interactions, running FDR on age models controlling for TF

#list models
models_lag<- c(lag_naa_age_TisFrac, lag_cre_age_TisFrac, lag_cho_age_TisFrac, lag_ins_age_TisFrac, lag_glx_age_TisFrac)

#list p-values for age in each model
p_lag<-models_lag %>%
  map(summary) %>%
  map(coef) %>%
  map_dbl(14) #index of p-val for age in coef list

model_names<-c("NAA", "Cre", "Cho", "Ins", "Glx")
fdr_table_lag_new<-data.frame(model_names, p_lag)

fdr_table_lag_new$p_fdr<-p.adjust(p_lag, method = "fdr", n=length(p_lag))
colnames(fdr_table_lag_new)<- c("Metabolite", "p, unc.", "p, FDR")

write.csv(fdr_table_lag_new, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/fdr_table_lag_age_tf_noInt.csv")


#run FDR correction on interaction terms (LAG: Cho, Ins)
#pull p-values for interaction term from relevant models
p_lag_age_int<-models_lag_int %>%
  map(summary) %>%
  map(coef) %>%
  map(20) #index of p-val for age in coef list including interaction term

#run FDR
p_fdr_int<-p.adjust(p_lag_age_int, method = "fdr", n= length(p_lag_age_int))

model_names_int<-c("Cho", "Ins")

#put it into a dataframe
fdr_table_int<-data.frame(model_names_int, unlist(p_lag_age_int), p_fdr_int)
colnames(fdr_table_int)<- c("Metabolite", "p, unc.", "p, FDR")

write.csv(fdr_table_int, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/fdr_table_int.csv")


#run FDR correction on Tissue Fraction effects for LAG models
#list p-values for age in age + tf models, 
p_lag_tf<-models_lag %>%
  map(summary) %>%
  map(coef) %>%
  map(13) #index of p-val for age in coef list

#list p-values for age in interaction models 
p_lag_tf_int<-models_lag_int %>%
  map(summary) %>%
  map(coef) %>%
  map(19) #index of p-val for age in coef list including interaction term


model_names_lag<-c("NAA", "Cre", "Glx", "Cho", "Ins") #arranged to match order of models listed 

#combine lists of p-values from models
p_lag_tf_all<-unlist(c(p_lag_tf, p_lag_tf_int))

#run FDR correction
p_fdr_lag_tf<-p.adjust(p_lag_tf_all, method = "fdr", n=length(p_lag_tf_all))

#create dataframe for output
fdr_table_lag_tf<-data.frame(model_names_lag, p_lag_tf_all, p_fdr_lag_tf)

colnames(fdr_table_lag_tf)<- c("Metabolite", "p, unc.", "p, FDR")

write.csv(fdr_table_lag_tf, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/fdr_table_lag_tf.csv")


```

##Test individual differences in slopes of LAG subjects with >2 time points 
Exploratory analysis
```{r}

#list all subjects with >2 time points
lag_subs_long<-group_by(lag_dat, subj_id) %>%
  summarise(n=n()) %>%
  filter(n > 2)

length(lag_subs_long$subj_id) #52 subjects have data for >2 time points

#filter dataset to subjects with >2 time points
lag_dat_long <- lag_dat %>%
                    filter(subj_id %in% lag_subs_long$subj_id)

#fit random slopes models in longitudinal subset
lag_naa_TisFrac_age_long <-lmer(NAA_conc_molal ~ TissueFraction_GMWM + mri_age_y + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_naa_TisFrac_age_long)

lag_naa_TisFrac_age_randslope <- lmer(NAA_conc_molal ~ TissueFraction_GMWM + mri_age_y + (1 + mri_age_y | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_naa_TisFrac_age_randslope)

#compare model fit
anova(lag_naa_TisFrac_age_long, lag_naa_TisFrac_age_randslope) #including random slopes did not improve fit

#Glx
lag_glx_TisFrac_age_long <-lmer(Glu_Gln_conc_molal ~ TissueFraction_GMWM + mri_age_y + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_glx_TisFrac_age_long)

#quadratic model
lag_dat_long$mri_age_y2 <- lag_dat_long$mri_age_y^2
lag_glx_TisFrac_age_long_quad <-lmer(Glu_Gln_conc_molal ~ TissueFraction_GMWM + mri_age_y + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_glx_TisFrac_age_long_quad)

#compare models
anova(lag_glx_TisFrac_age_long, lag_glx_TisFrac_age_long_quad) #sig. improved fit

#add random slope
lag_glx_TisFrac_age_long_quad_randslope <-lmer(Glu_Gln_conc_molal ~ TissueFraction_GMWM + mri_age_y + mri_age_y2 + (1 + mri_age_y + mri_age_y2 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_glx_TisFrac_age_long_quad_randslope)
coef(lag_glx_TisFrac_age_long_quad_randslope) #show different slopes for every subject

#compare models
anova(lag_glx_TisFrac_age_long_quad, lag_glx_TisFrac_age_long_quad_randslope) #not different

#Plot Glx quadratic
#pull fixed effects for overall model
fixef.lag_glx_TisFrac_age_long_quad<-fixef(lag_glx_TisFrac_age_long_quad)

#subset dataframe with only subjects included in NAA analysis
lag_dat_long_plot<- lag_dat_long %>% 
  filter(! is.na(Glu_Gln_conc_molal))

#calculate partial effect tissue fraction on tNAA (remove effect of tf)
lag_glx_long_age_partial <- remef(lag_glx_TisFrac_age_long_quad, fix = c("TissueFraction_GMWM", "mri_age_y2")) #does NOT remove random effects variance

#create plot to show NAA ~ age while controlling for Tissue Fraction
plot_lag_glx_tf<-ggplot(lag_dat_long_plot, aes(x=mri_age_y, y=Glu_Gln_conc_molal, na.exclude = TRUE, color=as.factor(female))) +
  geom_point() +
  geom_line(se = FALSE, aes(x=mri_age_y, y=Glu_Gln_conc_molal, group=as.factor(subj_id)), size = .3, show.legend = FALSE) +
  labs(title = "Left Temporo-Parietal", x = "age", y = "Glx") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_abline(aes(intercept = fixef.lag_glx_TisFrac_age_long_quad[[1]], slope = fixef.lag_glx_TisFrac_age_long_quad[[4]])) + 
  theme_classic()
plot_lag_glx_tf


```

##Test quadratic effects in LAG subjects with >2 time points 
Exploratory analysis to characterize change within subjects
```{r}
#read data
lag_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319_tissuefraction.csv")

#list all subjects with >2 time points
lag_subs_long<-group_by(lag_dat, subj_id) %>%
  summarise(n=n()) %>%
  filter(n > 2)

length(lag_subs_long$subj_id) #52 subjects have data for >2 time points

#filter dataset to subjects with >2 time points
lag_dat_long <- lag_dat %>%
                    filter(subj_id %in% lag_subs_long$subj_id)

#create quadratic age term
lag_dat_long$mri_age_y2<- (lag_dat_long$mri_age_y)^2

#save longtidudinal data set
write.csv(lag_dat_long, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_3plus_visits.csv")

#longitudinal dataset descriptives
lag_long_sex <- lag_dat_long %>%
  dplyr::select(subj_id, female)
lag_long_unique_subs<-unique(lag_long_sex)
length(lag_long_unique_subs$subj_id)
sum(lag_long_unique_subs$female)

#pull means and SDs of metabolites
lag_long_desc<-lag_dat_long %>%
  describe() %>%
  select(c("n", "mean", "sd", "min", "max"))
lag_long_desc<-filter(lag_long_desc, row.names(lag_long_desc) %in% c("mri_age_y", "NAA_conc_molal", "Cho_GPC_PCh_conc_molal", "Cre_PCr_conc_molal", "Glu_Gln_conc_molal", "Ins_conc_molal", "TissueFraction_GMWM"))
write.csv(lag_long_desc,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_long_metab_means.csv")

#NAA
#fit age + tissue fraction model in longitudinal subset
lag_naa_TisFrac_age_long <-lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_naa_TisFrac_age_long)

lag_naa_TisFrac_age_long_quad <-lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_naa_TisFrac_age_long_quad)

#compare model fit
anova(lag_naa_TisFrac_age_long, lag_naa_TisFrac_age_long_quad) #including quadratic term did not improve fit

#Cho
#fit age + tissue fraction model in longitudinal subset
lag_cho_TisFrac_age_long <-lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_cho_TisFrac_age_long)

lag_cho_TisFrac_age_long_quad <-lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_cho_TisFrac_age_long_quad)

#compare model fit
anova(lag_cho_TisFrac_age_long, lag_cho_TisFrac_age_long_quad) #including quadratic term improved fit

#add sex
lag_cho_TisFrac_age_long_quad_sex <-lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + female + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_cho_TisFrac_age_long_quad_sex)

#Cre
#fit age + tissue fraction model in longitudinal subset
lag_cre_TisFrac_age_long <-lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_cre_TisFrac_age_long)

lag_cre_TisFrac_age_long_quad <-lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_cre_TisFrac_age_long_quad)

#compare model fit
anova(lag_cre_TisFrac_age_long, lag_cre_TisFrac_age_long_quad) #including quadratic term did not improve fit

#Ins
#fit age + tissue fraction model in longitudinal subset
lag_ins_TisFrac_age_long <-lmer(Ins_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_ins_TisFrac_age_long)

lag_ins_TisFrac_age_long_quad <-lmer(Ins_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_ins_TisFrac_age_long_quad)

#compare model fit
anova(lag_ins_TisFrac_age_long, lag_ins_TisFrac_age_long_quad) #including quadratic term did not improve fit


#Glx
#fit age + tissue fraction model in longitudinal subset
lag_glx_TisFrac_age_long <-lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_glx_TisFrac_age_long)

#quadratic model
lag_glx_TisFrac_age_long_quad <-lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_glx_TisFrac_age_long_quad)

#compare models
anova(lag_glx_TisFrac_age_long, lag_glx_TisFrac_age_long_quad) #sig. improved fit

#add sex
lag_glx_TisFrac_age_long_quad_sex <-lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + female + (1 | subj_id), data=lag_dat_long, REML=FALSE)
summary(lag_glx_TisFrac_age_long_quad_sex)

#compare models
anova(lag_glx_TisFrac_age_long_quad, lag_glx_TisFrac_age_long_quad_sex) #not sig.

#Print model summaries to table
library(sjPlot)

lag_long_summary_table_all<-tab_model(lag_naa_TisFrac_age_long, lag_cre_TisFrac_age_long, lag_cho_TisFrac_age_long_quad, lag_glx_TisFrac_age_long_quad, lag_ins_TisFrac_age_long, show.std = TRUE, show.re.var=FALSE, show.icc = FALSE, show.r2=FALSE)
lag_long_summary_table_all #opens in Rstudio viewer, can open from there to web browser and save as PDF or whatever


#FDR correction
#list models
models_long<- c(lag_naa_TisFrac_age_long, lag_cre_TisFrac_age_long, lag_ins_TisFrac_age_long)
models_quad<- c(lag_cho_TisFrac_age_long_quad, lag_glx_TisFrac_age_long_quad)

#list p-values for age in each model
p_long<-models_long %>%
  map(summary) %>%
  map(coef) %>%
  map_dbl(14) #index of p-val for age in coef list

p_quad_age<-models_quad %>%
  map(summary) %>%
  map(coef) %>%
  map_dbl(18) 

p_long_age<-c(p_long, p_quad_age)

model_names<-c("NAA", "Cre", "Ins","Cho", "Glx")
fdr_table_long_age<-data.frame(model_names, p_long_age)

fdr_table_long_age$p_fdr<-p.adjust(p_long_age, method = "fdr", n=length(p_long_age))
colnames(fdr_table_long_age)<- c("Metabolite", "p, unc.", "p, FDR")

write.csv(fdr_table_long_age, "/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/fdr_table_long_age.csv")

p_quad_age2<-models_quad %>%
  map(summary) %>%
  map(coef) %>%
  map_dbl(20) 

model_names<-c("Cho", "Glx")
fdr_table_quad_age2<-data.frame(model_names, p_quad_age2)

fdr_table_quad_age2$p_fdr<-p.adjust(p_quad_age2, method = "fdr", n=length(p_quad_age2))
colnames(fdr_table_quad_age2)<- c("Metabolite", "p, unc.", "p, FDR")
fdr_table_quad_age2

```

##Plot longitudinal subset

```{r}
#Plot NAA linear
#subset dataframe with only subjects included in NAA analysis
lag_dat_long_naa<- lag_dat_long %>% 
  filter(! is.na(NAA_conc_molal))

#calculate partial effect tissue fraction on tNAA (remove effect of tissue fraction)
lag_naa_age_long_partial <- remef(lag_naa_TisFrac_age_long, fix = "TissueFraction_GMWM") 

plot_lag_naa_tf_long<-ggplot(lag_dat_long_naa, aes(x=mri_age_y, y=lag_naa_age_long_partial, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female)), size=1) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_naa_age_long_partial, group=as.factor(subj_id), color=as.factor(female)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "tNAA (controlling for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, colour = "black", size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(8,18), breaks=seq(8,18,1)) +
  theme_classic(base_size=12) +
  theme(legend.position = 'none') 
plot_lag_naa_tf_long
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_naa_long_age_tf_partial.png", plot=plot_lag_naa_tf_long)

#Plot Cho quadratic 
#subset dataframe with only subjects included in tCho analysis
lag_dat_long_cho<- lag_dat_long %>% 
  filter(! is.na(Cho_GPC_PCh_conc_molal))

#calculate partial effect tissue fraction on tCho (remove effect of tissue fraction)
lag_cho_age_long_partial <- remef(lag_cho_TisFrac_age_long_quad, fix = "TissueFraction_GMWM") 

plot_lag_cho_tf_quad<-ggplot(lag_dat_long_cho, aes(x=mri_age_y, y=lag_cho_age_long_partial, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female)), size=1) +
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x,2), aes(x=mri_age_y, y=lag_cho_age_long_partial, group=as.factor(subj_id), color=as.factor(female)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "tCho (controlling for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = FALSE, colour = "black", size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(1,4), breaks=seq(1,4,1)) +
  theme_classic(base_size=12) +
  theme(legend.position = c(.8,.9), legend.background = element_rect(fill="transparent", linetype = NULL)) 
plot_lag_cho_tf_quad
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cho_long_age_quad_partial.png", plot=plot_lag_cho_tf_quad)

#find min value and age when it occurs
#create formula for fit line
fit_cho<-lm(lag_cho_age_long_partial ~ poly(mri_age_y,2), data=lag_dat_long_cho)
lag_dat_long_cho$predict<-predict(fit_cho)

#view it to check
plot_lag_cho_tf_quad +
  geom_line(aes(y=predict), data=lag_dat_long_cho, linetype = 2, size=3, col="red")

#min Y value
min(lag_dat_long_cho$predict)
#plot it
plot_lag_cho_tf_quad +
  geom_hline(yintercept=min(lag_dat_long_cho$predict), linetype = 2)

#occurs at age
lag_dat_long_cho$mri_age_y[which.min(lag_dat_long_cho$predict)]


#Plot Cre linear
#subset dataframe with only subjects included in tCre analysis
lag_dat_long_cre<- lag_dat_long %>% 
  filter(! is.na(Cre_PCr_conc_molal))

#calculate partial effect tissue fraction on tCre (remove effect of tissue fraction)
lag_cre_age_long_partial <- remef(lag_cre_TisFrac_age_long, fix = "TissueFraction_GMWM") 

plot_lag_cre_tf_long<-ggplot(lag_dat_long_cre, aes(x=mri_age_y, y=lag_cre_age_long_partial, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female)),size=1) +
  geom_smooth(method = "lm", se = FALSE, aes(x=mri_age_y, y=lag_cre_age_long_partial, group=as.factor(subj_id), color=as.factor(female)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "tCre (controlling for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", se = FALSE, colour = "black", size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(3,12), breaks=seq(3,12,1)) +
  theme_classic(base_size=12) +
  theme(legend.position = 'none')
plot_lag_cre_tf_long
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_cre_long_age_partial.png", plot=plot_lag_cre_tf_long)

#Plot Glx quadratic
#subset dataframe with only subjects included in Glx analysis
lag_dat_long_glx<- lag_dat_long %>% 
  filter(! is.na(Glu_Gln_conc_molal))

#calculate partial effect tissue fraction on Glx (remove effect of tissue fraction)
lag_glx_age_long_partial <- remef(lag_glx_TisFrac_age_long_quad, fix = "TissueFraction_GMWM") 

plot_lag_glx_tf_quad<-ggplot(lag_dat_long_glx, aes(x=mri_age_y, y=lag_glx_age_long_partial, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female)), size=1) +
  geom_smooth(method = "lm", se = FALSE, formula = y ~ poly(x,2), aes(x=mri_age_y, y=lag_glx_age_long_partial, group=as.factor(subj_id), color=as.factor(female)), size = .5, show.legend = FALSE) +
  labs(x = "Age (years)", y = "Glx (controlling for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2), se = FALSE, colour = "black", size=1) + 
  scale_x_continuous(limits=c(2,12), breaks=seq(2,12,1)) +
  scale_y_continuous(limits=c(7,22), breaks=seq(7,22,1)) +
  theme_classic(base_size=12)+
  theme(legend.position= 'none')
plot_lag_glx_tf_quad
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_glx_long_age_quad_partial.png", plot=plot_lag_glx_tf_quad)

#find max value and age when it occurs
#create formula for fit line
fit_glx<-lm(lag_glx_age_long_partial ~ poly(mri_age_y,2), data=lag_dat_long_glx)
lag_dat_long_glx$predict<-predict(fit_glx)

#view it to check
plot_lag_glx_tf_quad +
  geom_line(aes(y=predict), data=lag_dat_long_glx, linetype = 2, size=3, col="red")

#max Y value
max(lag_dat_long_glx$predict)
#plot it
plot_lag_glx_tf_quad +
  geom_hline(yintercept=max(lag_dat_long_glx$predict), linetype = 2)

#occurs at age
lag_dat_long_glx$mri_age_y[which.max(lag_dat_long_glx$predict)]

#gather plots in a single figure
library(patchwork)
lag_long_fig<-plot_lag_naa_tf_long + plot_lag_cho_tf_quad + plot_lag_cre_tf_long + plot_lag_glx_tf_quad + plot_layout(nrow=2)
lag_long_fig
ggsave("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/results_lag_long_n52_partial.png", lag_long_fig, width = 2000, height = 1800, units = "px")

#Glx has 1 high value, maybe outlier - let's check
ggplot(lag_dat_long, aes(Glu_Gln_conc_molal)) + geom_boxplot()
rosnerTest(lag_dat_long$Glu_Gln_conc_molal, k = 4) #no sig. outliers, high value = 29.12

Glx_29<-filter(lag_dat_long, Glu_Gln_conc_molal>29) #subj ID 10094, study cod PS17_045
sub10094<-filter(lag_dat_long, subj_id==10094)

ggplot(sub10094, aes(mri_age_y, Glu_Gln_conc_molal)) + geom_point()
#jumps quite a bit from age 4 and 4.5 sessions to age 6 session, but other than that seems ok
ggplot(sub10094, aes(mri_age_y, TissueFraction_GMWM)) + geom_point()

```
##Try GAMMs for spline fitting in longitudinal subset
#per Ashley W's suggestion at Lebel Lab meeting 2/22
```{r}
library(mgcv)

lag_dat_long<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_3plus_visits.csv")

#NAA
#fit age + tissue fraction model in longitudinal subset

lag_naa_TisFrac_age_gamm <- gam(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + s(subj_id, bs="re") +  s(mri_age_y, subj_id, bs="re"), method="REML", data=lag_dat_long)
          
summary(lag_naa_TisFrac_age_gamm)


#Cho
lag_cho_TisFrac_age_gamm <- gam(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + s(subj_id, bs="re") +  s(mri_age_y, subj_id, bs="re"), method="REML", data=lag_dat_long)
summary(lag_cho_TisFrac_age_gamm)

#Plot Glx loess

plot_lag_glx_tf_gamm<-ggplot(lag_dat_long, aes(x=mri_age_y, y=Glu_Gln_conc_molal, na.exclude = TRUE)) +
  geom_point(aes(color=as.factor(female)), size=1) +
  labs(x = "Age (years)", y = "Glx (controlling for tissue fraction)") +
  scale_color_viridis(name = "Sex", labels = c("Male", "Female"), discrete = TRUE, option = "H", begin = .2, end = .8) +
  geom_smooth(se = FALSE, colour = "black", size=1) + 
  theme_classic(base_size=12)+
  theme(legend.position= 'none')
plot_lag_glx_tf_gamm

#Glx GAMM
lag_glx_TisFrac_age_gamm <- gam(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + s(subj_id, bs="re") + s(mri_age_y, subj_id, bs="re") , method="REML", data=lag_dat_long) 
          
summary(lag_glx_TisFrac_age_gamm)


```

##Calculate groupwise % change for all models
```{r}
#read data
acg_dat_tf<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/acg_data_molal_outliers_removed_n112_tissuefraction.csv")

lag_dat<-read.csv("/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/data/lag_data_molal_outliers_removed_n319_tissuefraction.csv")

#acg models
acg_naa_age <- lmer(NAA_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
acg_cho_age <- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
acg_cre_age <- lmer(Cre_PCr_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
acg_glx_age <- lmer(Glu_Gln_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)
acg_ins_age <- lmer(Ins_conc_molal ~ mri_age_y + (1 | subj_id), data=acg_dat_tf, REML=FALSE)

#lag models
lag_naa_age_TisFrac <- lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
lag_cho_age_TisFrac <- lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
lag_cre_age_TisFrac <- lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
lag_glx_age_TisFrac <- lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)
lag_ins_age_TisFrac <- lmer(Ins_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat, REML=FALSE)

#lag long models
lag_naa_TisFrac_age_long <-lmer(NAA_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
lag_cre_TisFrac_age_long <-lmer(Cre_PCr_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
lag_ins_TisFrac_age_long <-lmer(Ins_conc_molal ~ mri_age_y + TissueFraction_GMWM + (1 | subj_id), data=lag_dat_long, REML=FALSE)
lag_cho_TisFrac_age_long_quad <-lmer(Cho_GPC_PCh_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)
lag_glx_TisFrac_age_long_quad <-lmer(Glu_Gln_conc_molal ~ mri_age_y + TissueFraction_GMWM + mri_age_y2 + (1 | subj_id), data=lag_dat_long, REML=FALSE)


#create function to calculate predicted total percent change 
tot_pct <- function(model, a, b) {
  output<- ((fixef(model)[1] + fixef(model)[2]*b) - (fixef(model)[1] + fixef(model)[2]*a))/(fixef(model)[1] + fixef(model)[2]*a)*100
  return(output)
}

#test it
tot_pct(model = acg_naa_age, a=2, b=8)

#create function to calculate predicted annualized percent change
ann_pct <- function(model, a, b) {
  output<- ((fixef(model)[1] + fixef(model)[2]*b) - (fixef(model)[1] + fixef(model)[2]*a))/(fixef(model)[1] + fixef(model)[2]*a)/(b-a)*100
  return(output)
}
#test it
ann_pct(model = acg_naa_age, a=2, b=8)


#run percent change functions on acg models, spanning ages 2-8 and write to dataframe
acg_models<-c(acg_naa_age, acg_cho_age, acg_cre_age, acg_glx_age, acg_ins_age)
acg_model_names<-c("NAA","Cho", "Cre", "Glx", "Ins")
acg_tot_pct<-lapply(acg_models, tot_pct, a=2, b=8)
acg_ann_pct<-lapply(acg_models, ann_pct, a=2, b=8)

acg_pct.df<-data.frame(acg_model_names, unlist(acg_tot_pct), unlist(acg_ann_pct))

write.csv(acg_pct.df,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/acg_pct_chg.csv", row.names=FALSE)

#run percent change functions on lag models, spanning ages 2-12 and write to dataframe
lag_models<-c(lag_naa_age_TisFrac, lag_cho_age_TisFrac, lag_cre_age_TisFrac, lag_glx_age_TisFrac, lag_ins_age_TisFrac)
lag_model_names<-c("NAA","Cho", "Cre", "Glx", "Ins")
lag_tot_pct<-lapply(lag_models, tot_pct, a=2, b=12)
lag_ann_pct<-lapply(lag_models, ann_pct, a=2, b=12)

lag_pct.df<-data.frame(lag_model_names, unlist(lag_tot_pct), unlist(lag_ann_pct))

write.csv(lag_pct.df,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/lag_pct_chg.csv", row.names=FALSE)

#create percent change formula for quadratic functions
tot_pct_quad <- function(model, a, b) {
  output<- ((fixef(model)[1] + fixef(model)[2]*b +fixef(model)[4]*b^2) - (fixef(model)[1] + fixef(model)[2]*a + fixef(model)[4]*a^2))/(fixef(model)[1] + fixef(model)[2]*a +fixef(model)[4]*a^2)*100
  return(output)
}

ann_pct_quad <- function(model, a, b) {
  output<- ((fixef(model)[1] + fixef(model)[2]*b +fixef(model)[4]*b^2) - (fixef(model)[1] + fixef(model)[2]*a + fixef(model)[4]*a^2))/(fixef(model)[1] + fixef(model)[2]*a +fixef(model)[4]*a^2)/(b-a)*100
  return(output)
}

#test it
tot_pct_quad(model = lag_cho_TisFrac_age_long_quad, a=2, b=12)

#run percent change on lag longitudinal models, spanning ages 2-12 and write to dataframe
long_models_lin<-c(lag_naa_TisFrac_age_long, lag_cre_TisFrac_age_long, lag_ins_TisFrac_age_long)
long_tot_pct<-lapply(long_models_lin, tot_pct, a=2, b=12)
long_ann_pct<-lapply(long_models_lin, ann_pct, a=2, b=12)

long_models_quad<-c(lag_cho_TisFrac_age_long_quad, lag_glx_TisFrac_age_long_quad)
quad_tot_pct<-lapply(long_models_quad, tot_pct_quad, a=2, b=12)
quad_ann_pct<-lapply(long_models_quad, ann_pct_quad, a=2, b=12)

long_model_names<-c("NAA", "Cre", "Ins", "Cho", "Glx")
long_tot_pct_all<-c(long_tot_pct, quad_tot_pct)
long_ann_pct_all<-c(long_ann_pct, quad_ann_pct)
long_pct.df<-data.frame(long_model_names, unlist(long_tot_pct_all), unlist(long_ann_pct_all))

write.csv(long_pct.df,"/Users/meaghan/OneDrive - University of Calgary/Preschool_data/MRS/results/long_pct_chg.csv", row.names=FALSE)

#find min/max points
quad<-(fixef(model)[1] + fixef(model)[2]*b +fixef(model)[4]*b^2)
max<- fixef(model)[1] - (fixef(model)[2])^2/4*fixef(model)[4]

model<-lag_glx_TisFrac_age_long_quad
-1(fixef(model)[2])/((fixef(model)[4])*2)

-.17367/(.00838*2)

```

